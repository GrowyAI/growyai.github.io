<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growy 重要/不紧急时间管理（周计划）</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1B5E20;
            --text-light: #607D8B;
        }
        
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #F0F4F8;
            color: #333;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* 顶部返回首页链接 */
        .back-link {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 0.875rem;
            color: var(--text-light);
            text-decoration: none;
            display: flex;
            align-items: center;
            font-weight: 500;
            transition: color 0.2s;
            z-index: 1000;
        }
        .back-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        select { appearance: none; -webkit-appearance: none; }
        
        /* 导出图片专用样式：确保绝对居中和层级 */
        .export-slot-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 6px;
        }
        .export-period-tag {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 8px;
            font-weight: 500;
            padding: 1px 3px;
            background: rgba(255, 255, 255, 0.25);
            border-radius: 2px;
            color: white;
            z-index: 10;
            transform: translateY(-0.4em);
        }
        .export-title-text {
            width: 100%;
            padding: 0 4px;
            font-size: 12px;
            font-weight: 700;
            line-height: 1.2;
            text-align: center;
            color: white;
            z-index: 5;
            word-break: break-all;
            transform: translateY(-0.2em);
        }
        
        /* 返回首页按钮样式 */
        .back-button {
            display: inline-block;
            border: 2px solid #2D5A5A;
            color: #2D5A5A;
            text-decoration: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            text-align: center;
            margin-top: 1rem;
            transition: all 0.2s;
        }
        .back-button:hover {
            background-color: #f5f5f5;
        }
        
        /* QR Code 容器 */
        #qrCodeContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #qrCodeContainer canvas {
            max-width: 100%;
            max-height: 100%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@19.2.3",
        "react-dom": "https://esm.sh/react-dom@19.2.3",
        "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
        "framer-motion": "https://esm.sh/framer-motion@12.26.2",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1"
      }
    }
    </script>
</head>
<body>
    <a href="index.html" class="back-link">← 返回首页</a>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useMemo, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { motion, AnimatePresence } from 'framer-motion';
        import html2canvas from 'html2canvas';

        // --- 常量与更深的配色 ---
        const PRIMARY_COLOR = '#2D5A5A'; 
        const COLOR_PARENT = '#3E664A'; // 更加深沉、高饱和的嫩绿
        const COLOR_SELF = '#4A6B82';   // 更加深沉、高饱和的深蓝
        
        const DAYS = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
        const RoleType = { PARENT: 'PARENT', SELF: 'SELF' };
        const TimePeriod = { 
            ANYTIME: '任意时段', 
            MORNING: '上午', 
            NOON: '中午', 
            AFTERNOON: '下午', 
            EVENING: '晚上' 
        };

        const PRESETS = {
            [RoleType.PARENT]: [
                { title: '陪孩子阅读 15 分钟', frequency: 2 },
                { title: '真诚赞扬孩子 5 分钟', frequency: 1 },
                { title: '和孩子去公园', frequency: 1 },
            ],
            [RoleType.SELF]: [
                { title: '锻炼 15 分钟', frequency: 2 },
                { title: '自我反思', frequency: 1 },
                { title: '安静读书', frequency: 1 },
            ]
        };

        const Icons = {
            Parent: () => React.createElement('svg', { width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' }, 
                React.createElement('path', { d: 'M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z' })),
            Self: () => React.createElement('svg', { width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('path', { d: 'M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2' }),
                React.createElement('circle', { cx: 12, cy: 7, r: 4 })),
            Download: () => React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }),
                React.createElement('polyline', { points: '7 10 12 15 17 10' }),
                React.createElement('line', { x1: 12, x2: 12, y1: 15, y2: 3 })),
            Help: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
                React.createElement('path', { d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3' }),
                React.createElement('line', { x1: 12, x2: 12.01, y1: 17, y2: 17 })),
            Delete: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
                React.createElement('path', { d: 'M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2' }))
        };

        const App = () => {
            const [tasks, setTasks] = useState([]);
            const [schedule, setSchedule] = useState(DAYS.map(day => ({ day, tasks: [] })));
            const [isReflectionOpen, setIsReflectionOpen] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [qrCodeUrl, setQrCodeUrl] = useState('');

            // 生成二维码
            React.useEffect(() => {
                const container = document.createElement('div');
                const qr = new QRCode(container, {
                    text: 'https://growy.pages.dev/',
                    width: 84,
                    height: 84,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.L  // L = 最低纠错，二维码最简单
                });
                
                // 等待二维码生成完成
                setTimeout(() => {
                    const canvas = container.querySelector('canvas');
                    if (canvas) {
                        setQrCodeUrl(canvas.toDataURL('image/png'));
                    }
                }, 100);
            }, []);

            // 获取所有尚未分配的实例，并去重以便在下拉框展示
            const unscheduledInstances = useMemo(() => {
                const all = [];
                tasks.forEach(t => {
                    const scheduledCount = schedule.reduce((acc, day) => acc + day.tasks.filter(st => st.definitionId === t.id).length, 0);
                    const remaining = t.frequency - scheduledCount;
                    for (let i = 0; i < remaining; i++) {
                        all.push({ 
                            id: `${t.id}-${scheduledCount + i}-${Date.now()}`, 
                            definitionId: t.id, 
                            title: t.title, 
                            role: t.role,
                            period: TimePeriod.ANYTIME 
                        });
                    }
                });
                return all;
            }, [tasks, schedule]);

            const uniqueOptions = useMemo(() => {
                const seen = new Set();
                return unscheduledInstances.filter(inst => {
                    if (seen.has(inst.definitionId)) return false;
                    seen.add(inst.definitionId);
                    return true;
                });
            }, [unscheduledInstances]);

            const addTask = (role, preset) => {
                const id = Math.random().toString(36).substr(2, 9);
                setTasks(prev => [...prev, { id, role, title: preset?.title || '', frequency: preset?.frequency || 1 }]);
            };

            const scheduleTaskByIndex = (dayName, optIndex) => {
                if (optIndex === "") return;
                const defId = uniqueOptions[parseInt(optIndex)].definitionId;
                const instance = unscheduledInstances.find(inst => inst.definitionId === defId);
                
                if (instance) {
                    setSchedule(prev => prev.map(day => {
                        if (day.day === dayName && day.tasks.length < 2) {
                            return { ...day, tasks: [...day.tasks, { ...instance }] };
                        }
                        return day;
                    }));
                }
            };

            const removeScheduled = (dayName, id) => {
                setSchedule(prev => prev.map(day => day.day === dayName ? { ...day, tasks: day.tasks.filter(t => t.id !== id) } : day));
            };

            const updatePeriod = (dayName, id, period) => {
                setSchedule(prev => prev.map(day => day.day === dayName ? { ...day, tasks: day.tasks.map(t => t.id === id ? { ...t, period } : t) } : day));
            };

            const handleExport = async () => {
                const el = document.getElementById('export-card');
                setIsExporting(true);
                const canvas = await html2canvas(el, { scale: 3, backgroundColor: '#F0F4F8', logging: false, useCORS: true });
                const link = document.createElement('a');
                link.download = `Growy-周计划-${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                setIsExporting(false);
            };

            return React.createElement('div', { className: 'min-h-screen pb-20' },
                // Header
                React.createElement('header', { className: 'py-12 px-6 text-center bg-white border-b border-[#E0E7ED]' },
                    React.createElement(motion.h1, { initial: { opacity: 0, y: -10 }, animate: { opacity: 1, y: 0 }, className: 'text-2xl font-bold mb-2', style: { color: PRIMARY_COLOR } }, '「重要/不紧急」周计划'),
                    React.createElement('p', { className: 'text-gray-700 text-base' }, '把真正重要但不紧急的事，先放进这一周'),
                    React.createElement('p', { className: 'text-gray-600 text-sm mt-1' }, '不打卡 · 不监督 · 只是对自己的承诺')
                ),

                // Concept Intro (四象限图)
                React.createElement('section', { className: 'px-6 py-8 max-w-lg mx-auto text-center' },
                    React.createElement('div', { className: 'bg-white/50 backdrop-blur-sm p-6 rounded-2xl border border-white/80 shadow-sm' },
                        React.createElement('p', { className: 'text-gray-700 leading-relaxed text-base' }, 
                            '第四代时间管理的核心不是更高效，', React.createElement('br'),
                            '而是先守住那些', React.createElement('span', { className: 'font-semibold', style: { color: PRIMARY_COLOR } }, '最容易被挤掉、却最重要的事'), '。'
                        ),
                        React.createElement('div', { className: 'mt-6 flex justify-center' },
                            React.createElement('div', { className: 'grid grid-cols-2 gap-1 w-48 h-48' },
                                [['重要', '且紧急'], ['重要', '不紧急'], ['不重要', '但紧急'], ['不重要', '不紧急']].map(([t1, t2], i) => 
                                    React.createElement('div', { key: i, className: `rounded flex flex-col items-center justify-center p-1 text-xs ${i === 1 ? 'text-white shadow-sm' : 'border border-gray-200 text-gray-400'}`, style: i === 1 ? { backgroundColor: PRIMARY_COLOR } : {} },
                                        React.createElement('span', { className: 'font-bold' }, t1),
                                        React.createElement('span', null, t2)
                                    )
                                )
                            )
                        )
                    )
                ),

                // Main
                React.createElement('main', { className: 'max-w-lg mx-auto px-4 mt-8 space-y-10' },
                    
                    // 重要的事 - 引导文案
                    React.createElement('section', { className: 'space-y-2' },
                        React.createElement('h2', { className: 'text-lg font-bold px-1', style: { color: PRIMARY_COLOR } }, '重要的事'),
                        React.createElement('p', { className: 'text-gray-700 text-sm px-1' }, '这一周，选几件你不想放弃的事，并为它们留出时间。')
                    ),
                    
                    // Roles & Tasks
                    React.createElement('section', { className: 'space-y-4' },
                        [RoleType.PARENT, RoleType.SELF].map(role => React.createElement('div', { key: role, className: 'bg-white p-5 rounded-3xl shadow-sm border border-[#E0E7ED]' },
                            React.createElement('div', { className: 'flex items-center gap-2 mb-4' },
                                React.createElement('div', { className: 'p-1.5 rounded-lg text-white shadow-sm', style: { backgroundColor: role === RoleType.PARENT ? COLOR_PARENT : COLOR_SELF } }, role === RoleType.PARENT ? React.createElement(Icons.Parent) : React.createElement(Icons.Self)),
                                React.createElement('span', { className: 'font-bold text-gray-700 text-base' }, role === RoleType.PARENT ? '作为父母的我' : '作为自己的我')
                            ),
                            
                            // Presets
                            React.createElement('div', { className: 'flex flex-wrap gap-2 mb-4' },
                                PRESETS[role].map((p, idx) => React.createElement('button', { key: idx, onClick: () => addTask(role, p), className: 'text-sm px-2.5 py-1 rounded-full border border-gray-100 bg-gray-50 text-gray-600 hover:opacity-80 transition-all' }, `+ ${p.title}`))
                            ),
                            
                            // Task List
                            React.createElement('div', { className: 'space-y-2' },
                                tasks.filter(t => t.role === role).map(t => React.createElement('div', { key: t.id, className: 'flex items-center gap-3 p-2 bg-gray-50/50 rounded-xl border border-gray-100' },
                                    React.createElement('input', { type: 'text', value: t.title, onChange: e => setTasks(prev => prev.map(x => x.id === t.id ? { ...x, title: e.target.value } : x)), className: 'flex-1 bg-transparent border-none outline-none text-base py-1 placeholder-gray-300', placeholder: '输入核心事项...' }),
                                    React.createElement('div', { className: 'flex items-center gap-2 border-l border-gray-200 pl-2' },
                                                React.createElement('select', { value: t.frequency, onChange: e => setTasks(prev => prev.map(x => x.id === t.id ? { ...x, frequency: parseInt(e.target.value) } : x)), className: 'text-sm bg-white border border-gray-100 rounded px-1 py-0.5 outline-none' }, [1,2,3,4,5,6,7].map(n => React.createElement('option', { key: n, value: n }, `${n}次`))),
                                        React.createElement('button', { onClick: () => setTasks(prev => prev.filter(x => x.id !== t.id)), className: 'text-gray-300 hover:text-red-400 p-1' }, React.createElement(Icons.Delete))
                                    )
                                )),
                                React.createElement('button', { onClick: () => addTask(role), className: 'w-full py-2 border border-dashed border-gray-200 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-colors' }, '+ 自定义')
                            )
                        ))
                    ),

                    // Weekly Grid
                    React.createElement('section', { className: 'space-y-4' },
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex justify-between items-center px-1' },
                                React.createElement('h2', { className: 'text-lg font-bold', style: { color: PRIMARY_COLOR } }, '周计划'),
                                React.createElement('button', { onClick: () => setIsReflectionOpen(true), className: 'text-sm text-gray-600 flex items-center gap-1 hover:text-gray-800 transition-colors' }, React.createElement(Icons.Help), '很难安排得下？')
                            ),
                            React.createElement('p', { className: 'text-gray-700 text-sm px-1' }, '把上面的事放入一周中的某一天。可选时段，不必具体到几点。')
                        ),
                        React.createElement('div', { className: 'space-y-2' },
                            schedule.map(day => React.createElement('div', { key: day.day, className: 'bg-white px-4 py-3 rounded-2xl shadow-sm border border-[#E0E7ED] flex items-center gap-4' },
                                React.createElement('span', { className: 'font-bold text-sm text-gray-600 w-8' }, day.day),
                                React.createElement('div', { className: 'flex-1 grid grid-cols-2 gap-2 h-14' },
                                    [0, 1].map(idx => {
                                        const t = day.tasks[idx];
                                        return React.createElement('div', { key: idx, className: 'relative h-full' },
                                            t ? React.createElement(motion.div, { layoutId: t.id, className: 'h-full p-2 rounded-xl text-white flex flex-col justify-center shadow-md items-center text-center', style: { backgroundColor: t.role === RoleType.PARENT ? COLOR_PARENT : COLOR_SELF } },
                                                React.createElement('div', { className: 'flex justify-between w-full mb-1' },
                                                    React.createElement('span', { className: 'w-2' }),
                                                    React.createElement('span', { className: 'text-[13px] font-bold truncate flex-1 leading-tight' }, t.title || '未命名'),
                                                    React.createElement('button', { onClick: () => removeScheduled(day.day, t.id), className: 'opacity-50 hover:opacity-100 px-1' }, '×')
                                                ),
                                                React.createElement('select', { value: t.period || TimePeriod.ANYTIME, onChange: e => updatePeriod(day.day, t.id, e.target.value), className: 'bg-white/20 text-[11px] px-1 rounded-md outline-none border-none cursor-pointer w-full text-center' },
                                                    Object.values(TimePeriod).map(p => React.createElement('option', { key: p, value: p, className: 'text-black' }, p))
                                                )
                                            ) : (
                                                uniqueOptions.length > 0 ? React.createElement('select', { 
                                                    value: '',
                                                    onChange: e => scheduleTaskByIndex(day.day, e.target.value),
                                                    className: 'w-full h-full border border-dashed border-gray-200 bg-gray-50/50 rounded-xl text-sm text-gray-600 hover:bg-gray-100 transition-colors cursor-pointer px-2 outline-none text-center font-bold'
                                                },
                                                    React.createElement('option', { value: "" }, '放入...'),
                                                    uniqueOptions.map((opt, i) => 
                                                        React.createElement('option', { key: i, value: i, className: 'text-black' }, opt.title || '未命名')
                                                    )
                                                ) : React.createElement('div', { className: 'w-full h-full border border-dashed border-gray-50/10 rounded-xl' })
                                            )
                                        );
                                    })
                                )
                            ))
                        )
                    ),

                    // Download Button
                    React.createElement('section', { className: 'text-center pt-4 pb-20' },
                        React.createElement('button', { onClick: handleExport, disabled: isExporting, className: 'w-full py-4 bg-[#2D5A5A] text-white font-bold rounded-2xl shadow-xl flex items-center justify-center gap-2 active:scale-95 transition-all' },
                            React.createElement(Icons.Download),
                            React.createElement('span', null, isExporting ? '生成中...' : '下载本周计划卡')
                        ),
                        React.createElement('a', { href: 'index.html', className: 'back-button' }, '← 返回首页')
                    )
                ),

                // Reflection Modal
                isReflectionOpen && React.createElement('div', { className: 'fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-center justify-center px-6', onClick: () => setIsReflectionOpen(false) },
                    React.createElement('div', { className: 'bg-white p-8 rounded-3xl max-w-xs w-full shadow-2xl space-y-4', onClick: e => e.stopPropagation() },
                        React.createElement('h3', { className: 'font-bold text-center mb-4 text-lg', style: { color: PRIMARY_COLOR } }, '腾出时间的思考'),
                        [
                            '1. 哪件事如果你停一周，其实也不会出大问题？',
                            '2. 如果只能让一件事"不完美"，你希望是哪一件？',
                            '3. 哪件事是你自己在坚持，还是别人默认你会坚持？'
                        ].map((q, i) => React.createElement('p', { key: i, className: 'text-base text-gray-700 leading-relaxed' }, q)),
                        React.createElement('button', { onClick: () => setIsReflectionOpen(false), className: 'w-full py-3 bg-[#2D5A5A] text-white rounded-xl text-lg font-bold mt-4' }, '明白了')
                    )
                ),

                // Hidden Export Card (3:4 Ratio, Fully Centered Content) - 此处代码未改变以保证下载图片排版
                React.createElement('div', { className: 'fixed -left-[5000px] top-0' },
                    React.createElement('div', { id: 'export-card', className: 'w-[375px] h-[500px] bg-[#F0F4F8] p-6 flex flex-col justify-between shadow-none' },
                        React.createElement('div', { className: 'space-y-3' },
                            React.createElement('div', { className: 'text-center pb-4 border-b border-gray-200' },
                                React.createElement('h1', { className: 'text-2xl font-bold', style: { color: PRIMARY_COLOR } }, '我的「重要/不紧急」周计划'),
                                React.createElement('p', { className: 'text-[12px] text-gray-500 mt-1.5 uppercase tracking-[0.15em]' }, `即使很忙，也要尽力去做的事 · ${new Date().toLocaleDateString('zh-CN')}`)
                            ),
                            React.createElement('div', { className: 'space-y-1.5' },
                                schedule.map(day => React.createElement('div', { key: day.day, className: 'flex items-center gap-3' },
                                    React.createElement('span', { className: 'text-[10px] font-bold text-gray-400 w-10 text-right' }, day.day),
                                    React.createElement('div', { className: 'flex-1 flex gap-1.5 h-9' },
                                        [0, 1].map(idx => {
                                            const t = day.tasks[idx];
                                            return React.createElement('div', { 
                                                key: idx, 
                                                className: `flex-1 rounded-lg ${t ? 'shadow-sm' : 'border border-dashed border-gray-200'}`, 
                                                style: t ? { backgroundColor: t.role === RoleType.PARENT ? COLOR_PARENT : COLOR_SELF } : {} 
                                            },
                                                t ? React.createElement('div', { className: 'export-slot-container flex flex-col items-center justify-center h-full relative', style: { transform: 'translateY(-4px)' } },
                                                    t.period !== TimePeriod.ANYTIME && React.createElement('div', { className: 'export-period-tag' }, t.period),
                                                    React.createElement('div', { className: 'export-title-text font-semibold' }, t.title)
                                                ) : ''
                                            );
                                        })
                                    )
                                ))
                            )
                        ),
                        React.createElement('div', { className: 'pt-4 border-t border-gray-200 flex justify-between items-center' },
                            React.createElement('div', { className: 'space-y-1' },
                                React.createElement('p', { className: 'text-[12px] text-gray-400' }, '允许不完美，但要守住最重要的事'),
                                React.createElement('p', { className: 'text-[16px] font-bold text-gray-700' }, 'Growy | 彼此陪伴，共同新生')
                            ),
                            React.createElement('div', { className: 'w-20 h-20 bg-white border border-gray-100 rounded-lg flex flex-col items-center justify-center p-1' },
                                qrCodeUrl ? React.createElement('img', { src: qrCodeUrl, alt: 'Growy QR Code', className: 'w-full h-full object-contain' }) : React.createElement('div', { className: 'text-gray-300 text-[6px]' }, '加载中...')
                            )
                        )
                    )
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>